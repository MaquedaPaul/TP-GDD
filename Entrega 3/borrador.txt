USE GD2C2023
GO

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_FACT_ANUNCIOS')
DROP TABLE AMCGDD.BI_FACT_ANUNCIOS

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_MONEDA')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_MONEDA

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_OPERACION')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_OPERACION

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_INMUEBLE')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_INMUEBLE

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIEMPO')
DROP TABLE AMCGDD.BI_DIMENSION_TIEMPO

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_RANGO_M2')
DROP TABLE AMCGDD.BI_DIMENSION_RANGO_M2

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_RANGO_ETARIO')
DROP TABLE AMCGDD.BI_DIMENSION_RANGO_ETARIO

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_AMBIENTES')
DROP TABLE AMCGDD.BI_DIMENSION_AMBIENTES

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_SUCURSAL')
DROP TABLE AMCGDD.BI_DIMENSION_SUCURSAL

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_UBICACION')
DROP TABLE AMCGDD.BI_DIMENSION_UBICACION

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_BARRIO')
DROP TABLE AMCGDD.BI_BARRIO


IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_LOCALIDAD')
DROP TABLE AMCGDD.BI_LOCALIDAD

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_PROVINCIA')
DROP TABLE AMCGDD.BI_PROVINCIA



-----------LIMPIAMOS FUNCIONES

IF EXISTS(SELECT [name] FROM sys.objects WHERE [name] = 'CUATRIMESTREDE')
DROP FUNCTION AMCGDD.CUATRIMESTREDE
GO

-----------LIMPIAMOS PROCEDIMIENTOS
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_TIPO_MONEDA')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_MONEDA
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_BI_PROVINCIA')
	DROP PROCEDURE AMCGDD.MIGRACION_BI_PROVINCIA
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_BI_LOCALIDAD')
	DROP PROCEDURE AMCGDD.MIGRACION_BI_LOCALIDAD
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_BI_BARRIO')
	DROP PROCEDURE AMCGDD.MIGRACION_BI_BARRIO
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_RANGO_ETARIO')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_RANGO_ETARIO
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_RANGO_M2')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_RANGO_M2
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_TIPO_INMUEBLE')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_INMUEBLE
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_TIPO_OPERACION')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_OPERACION
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_SUCURSAL')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_SUCURSAL
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_AMBIENTES')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_AMBIENTES
GO
IF EXISTS(SELECT [name] FROM sys.procedures WHERE [name] = 'MIGRACION_DIMENSION_TIEMPO')
	DROP PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIEMPO
GO

----CREACION TABLAS

CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_MONEDA(
	MONEDA_NOMBRE NVARCHAR(100)
	PRIMARY KEY (MONEDA_NOMBRE)
)

CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_OPERACION(
	TIPO_OPERACION_ID NVARCHAR(20)
	PRIMARY KEY (TIPO_OPERACION_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_INMUEBLE(
	INMUEBLE_TIPO_ID NVARCHAR(100)
	PRIMARY KEY (INMUEBLE_TIPO_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_TIEMPO(
	TIEMPO_ID NUMERIC(19,0) IDENTITY,
	ANIO INT,
	MES INT,
	CUATRIMESTRE INT,
	PRIMARY KEY (TIEMPO_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_RANGO_M2(
	RANGO_M2_ID NVARCHAR(20)
	PRIMARY KEY (RANGO_M2_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_RANGO_ETARIO(
	RANGO_ETARIO_ID NVARCHAR(20)
	PRIMARY KEY (RANGO_ETARIO_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_AMBIENTES(
	AMBIENTE_ID NVARCHAR(100)
	PRIMARY KEY (AMBIENTE_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_SUCURSAL(
	SUCURSAL_ID NUMERIC(19,0),
	SUCURSAL_NOMBRE NVARCHAR(100),
	PRIMARY KEY (SUCURSAL_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_UBICACION(
	UBICACION_ID NUMERIC(19,0),
	BARRIO_ID NUMERIC(19,0),
	LOCALIDAD_ID NUMERIC(19,0),
	PROVINCIA_ID NUMERIC(19,0),
	PRIMARY KEY (UBICACION_ID)
)


CREATE TABLE AMCGDD.BI_LOCALIDAD(
	LOCALIDAD_ID NUMERIC(19,0),
	LOCALIDAD_NOMBRE NVARCHAR(100),
	LOCALIDAD_PROVINCIA NUMERIC(19,0),
	PRIMARY KEY (LOCALIDAD_ID)
)

CREATE TABLE AMCGDD.BI_PROVINCIA(
	PROVINCIA_ID NUMERIC(19,0),
	PROVINCIA_NOMBRE NVARCHAR(100),
	PRIMARY KEY (PROVINCIA_ID)
)

CREATE TABLE AMCGDD.BI_BARRIO(
	BARRIO_ID NUMERIC(19,0),
	BARRIO_NOMBRE NVARCHAR(100),
	BARRIO_LOCALIDAD_ID NUMERIC(19,0),
	PRIMARY KEY (BARRIO_ID)
)

-----CREAMOS FACT TABLES
CREATE TABLE AMCGDD.BI_FACT_ANUNCIOS(
	TIEMPO_ID NUMERIC(19,0),
	UBICACION_ID NUMERIC(19,0),
	SUCURSAL_ID NUMERIC(19,0),
	RANGO_ETARIO_INQUILINO_ID NVARCHAR(20),
	TIPO_INMUEBLE_ID NVARCHAR(100),
	AMBIENTES_ID NVARCHAR(100),
	RANGO_M2_ID NVARCHAR(20),
	TIPO_OPERACION_ID NVARCHAR(20),
	TIPO_MONEDA_ID NVARCHAR(100),
	ANUNCIO_DURACION NUMERIC(18,2),
	ANUNCIO_PRECIO NUMERIC(18,2),
	--ALQUILER_FECHA_INICIO
	INMUEBLE_SUPERIFICIE_TOTAL DECIMAL(18,0),
	--COMISION
	CONCRETADO BIT
)



-----AGREGAMOS CONSTRAINTS

ALTER TABLE AMCGDD.BI_BARRIO
ADD CONSTRAINT FK_BI_LOCALIDAD_ID
FOREIGN KEY (BARRIO_LOCALIDAD_ID) REFERENCES AMCGDD.BI_LOCALIDAD

ALTER TABLE AMCGDD.BI_LOCALIDAD
ADD CONSTRAINT FK_BI_PROVINCIA_ID
FOREIGN KEY (LOCALIDAD_PROVINCIA) REFERENCES AMCGDD.BI_PROVINCIA

----AHORA CONSTRAINTS A LAS FACT TABLES

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_TIEMPO_ID
FOREIGN KEY (TIEMPO_ID) REFERENCES AMCGDD.BI_DIMENSION_TIEMPO

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_UBICACION_ID
FOREIGN KEY (UBICACION_ID) REFERENCES AMCGDD.BI_DIMENSION_UBICACION

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_SUCURSAL_ID
FOREIGN KEY (SUCURSAL_ID) REFERENCES AMCGDD.BI_DIMENSION_SUCURSAL

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_RANGO_ETARIO_INQUILINO_ID
FOREIGN KEY (RANGO_ETARIO_INQUILINO_ID) REFERENCES AMCGDD.BI_DIMENSION_RANGO_ETARIO

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_TIPO_INMUEBLE_ID
FOREIGN KEY (TIPO_INMUEBLE_ID) REFERENCES AMCGDD.BI_DIMENSION_TIPO_INMUEBLE

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_AMBIENTES_ID
FOREIGN KEY (AMBIENTES_ID) REFERENCES AMCGDD.BI_DIMENSION_AMBIENTES

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_RANGO_M2_ID
FOREIGN KEY (RANGO_M2_ID) REFERENCES AMCGDD.BI_DIMENSION_RANGO_M2

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_TIPO_OPERACION_ID
FOREIGN KEY (TIPO_OPERACION_ID) REFERENCES AMCGDD.BI_DIMENSION_TIPO_OPERACION

ALTER TABLE AMCGDD.BI_FACT_ANUNCIOS
ADD CONSTRAINT FK_TIPO_MONEDA_ID
FOREIGN KEY (TIPO_MONEDA_ID) REFERENCES AMCGDD.BI_DIMENSION_TIPO_MONEDA



----CREAMOS FUNCIONES

GO
CREATE FUNCTION AMCGDD.CUATRIMESTREDE(@fecha DATETIME)
RETURNS INT
AS
BEGIN
    DECLARE @cuatrimestre INT
    SET @cuatrimestre = 
        CASE 
            WHEN MONTH(@fecha) BETWEEN 1 AND 4 THEN 1
            WHEN MONTH(@fecha) BETWEEN 5 AND 8 THEN 2
            WHEN MONTH(@fecha) BETWEEN 9 AND 12 THEN 3
            ELSE 0
			 -- En caso de fechas que no estén en un rango válido
        END
    RETURN @cuatrimestre
END
GO

------CREAMOS PROCEDIMIENTOS

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_MONEDA
AS
BEGIN
	PRINT 'MIGRACION TIPO MONEDA'
	INSERT INTO AMCGDD.BI_DIMENSION_TIPO_MONEDA
	SELECT MONEDA_NOMBRE FROM AMCGDD.MONEDA
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_BI_PROVINCIA
AS
BEGIN
	PRINT 'MIGRACION BI_PROVINCIA'
	INSERT INTO AMCGDD.BI_PROVINCIA
	SELECT * FROM AMCGDD.PROVINCIA
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_BI_LOCALIDAD
AS
BEGIN
	PRINT 'MIGRACION BI_LOCALIDAD'
	INSERT INTO AMCGDD.BI_LOCALIDAD
	SELECT * FROM AMCGDD.LOCALIDAD
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_BI_BARRIO
AS
BEGIN
	PRINT 'MIGRACION BI_BARRIO'
	INSERT INTO AMCGDD.BI_BARRIO
	SELECT * FROM AMCGDD.BARRIO
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_RANGO_ETARIO
AS
BEGIN
	PRINT 'MIGRACION DIMENSION RANGO ETARIO'
	INSERT INTO AMCGDD.BI_DIMENSION_RANGO_ETARIO
	VALUES('<25'),('25-35'),('35-50'),('>50')
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_RANGO_M2
AS
BEGIN
	PRINT 'MIGRACION DIMENSION RANGO M2'
	INSERT INTO AMCGDD.BI_DIMENSION_RANGO_M2
	VALUES('<35'),('35-55'),('55-75'),('75-100'),('100')
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_INMUEBLE
AS
BEGIN
	PRINT 'MIGRACION DIMENSION TIPO INMUEBLE'
	INSERT INTO AMCGDD.BI_DIMENSION_TIPO_INMUEBLE
	SELECT NOMBRE FROM AMCGDD.TIPO
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIPO_OPERACION
AS
BEGIN
	PRINT 'MIGRACION DIMENSION TIPO OPERACION'
	INSERT INTO AMCGDD.BI_DIMENSION_TIPO_OPERACION
	SELECT * FROM AMCGDD.ANUNCIO_TIPOS
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_SUCURSAL
AS
BEGIN
	PRINT 'MIGRACION DIMENSION SUCURSAL'
	INSERT INTO AMCGDD.BI_DIMENSION_SUCURSAL 
	SELECT SUCURSAL_ID, SUCURSAL_NOMBRE FROM AMCGDD.SUCURSAL
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_AMBIENTES
AS
BEGIN
	PRINT 'MIGRACION DIMENSION AMBIENTES'
	INSERT INTO AMCGDD.BI_DIMENSION_AMBIENTES
	SELECT nombre FROM AMCGDD.INMUEBLE_AMBIENTE
END

GO
CREATE PROCEDURE AMCGDD.MIGRACION_DIMENSION_TIEMPO
AS
BEGIN
	PRINT 'MIGRACION DE FECHAS'
---FECHAS ANUNCIOS
	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(anuncio_fecha), 
	DATEPART(MONTH, anuncio_fecha), 
	AMCGDD.CUATRIMESTREDE(anuncio_fecha) 
	FROM AMCGDD.ANUNCIOS
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(anuncio_fecha) AND 
		 MES = DATEPART(MONTH, anuncio_fecha))

	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(anuncio_finalizacion), 
	DATEPART(MONTH, anuncio_finalizacion), 
	AMCGDD.CUATRIMESTREDE(anuncio_finalizacion) 
	FROM AMCGDD.ANUNCIOS
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(anuncio_finalizacion) AND 
		 MES = DATEPART(MONTH, anuncio_finalizacion))

---FECHAS ALQUILERES
	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(alquiler_fecha_inicio), 
	DATEPART(MONTH, alquiler_fecha_inicio), 
	AMCGDD.CUATRIMESTREDE(alquiler_fecha_inicio) 
	FROM AMCGDD.ALQUILER
	WHERE NOT EXISTS 
		(SELECT * FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(alquiler_fecha_inicio) AND 
		 MES = DATEPART(MONTH, alquiler_fecha_inicio))
	
	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(alquiler_fecha_fin), 
	DATEPART(MONTH, alquiler_fecha_fin), 
	AMCGDD.CUATRIMESTREDE(alquiler_fecha_fin) 
	FROM AMCGDD.ALQUILER
	WHERE NOT EXISTS 
		(SELECT * FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(alquiler_fecha_fin) AND 
		 MES = DATEPART(MONTH, alquiler_fecha_fin))

	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(pago_fecha), 
	DATEPART(MONTH, pago_fecha), 
	AMCGDD.CUATRIMESTREDE(pago_fecha) 
	FROM AMCGDD.PAGO_ALQUILER
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(pago_fecha) AND 
		 MES = DATEPART(MONTH, pago_fecha))

	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(pago_inicio_periodo), 
	DATEPART(MONTH, pago_inicio_periodo), 
	AMCGDD.CUATRIMESTREDE(pago_inicio_periodo) 
	FROM AMCGDD.PAGO_ALQUILER
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(pago_inicio_periodo) AND 
		 MES = DATEPART(MONTH, pago_inicio_periodo))

	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(pago_fin_periodo), 
	DATEPART(MONTH, pago_fin_periodo), 
	AMCGDD.CUATRIMESTREDE(pago_fin_periodo) 
	FROM AMCGDD.PAGO_ALQUILER
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(pago_fin_periodo) AND 
		 MES = DATEPART(MONTH, pago_fin_periodo))

	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(pago_fecha_vencimiento), 
	DATEPART(MONTH, pago_fecha_vencimiento), 
	AMCGDD.CUATRIMESTREDE(pago_fecha_vencimiento) 
	FROM AMCGDD.PAGO_ALQUILER
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(pago_fecha_vencimiento) AND 
		 MES = DATEPART(MONTH, pago_fecha_vencimiento))

---FECHAS VENTAS
	INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO (ANIO, MES, CUATRIMESTRE)
	SELECT DISTINCT YEAR(VENTA_FECHA), 
	DATEPART(MONTH, VENTA_FECHA), 
	AMCGDD.CUATRIMESTREDE(VENTA_FECHA) 
	FROM AMCGDD.VENTA_INMUEBLE
	WHERE NOT EXISTS
		(SELECT 1 FROM AMCGDD.BI_DIMENSION_TIEMPO
		 WHERE ANIO = YEAR(VENTA_FECHA) AND 
		 MES = DATEPART(MONTH, VENTA_FECHA))
END
GO


USE GD2C2023
GO
EXEC AMCGDD.MIGRACION_DIMENSION_TIPO_MONEDA
EXEC AMCGDD.MIGRACION_BI_PROVINCIA
EXEC AMCGDD.MIGRACION_BI_LOCALIDAD
EXEC AMCGDD.MIGRACION_BI_BARRIO
EXEC AMCGDD.MIGRACION_DIMENSION_RANGO_ETARIO
EXEC AMCGDD.MIGRACION_DIMENSION_RANGO_M2
EXEC AMCGDD.MIGRACION_DIMENSION_TIPO_INMUEBLE
EXEC AMCGDD.MIGRACION_DIMENSION_TIPO_OPERACION
EXEC AMCGDD.MIGRACION_DIMENSION_SUCURSAL
EXEC AMCGDD.MIGRACION_DIMENSION_AMBIENTES
EXEC AMCGDD.MIGRACION_DIMENSION_TIEMPO

