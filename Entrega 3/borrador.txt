IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_MONEDA')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_MONEDA

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_OPERACION')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_OPERACION

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIPO_INMUEBLE')
DROP TABLE AMCGDD.BI_DIMENSION_TIPO_INMUEBLE

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_TIEMPO')
DROP TABLE AMCGDD.BI_DIMENSION_TIEMPO

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_RANGO_M2')
DROP TABLE AMCGDD.BI_DIMENSION_RANGO_M2

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_RANGO_ETARIO')
DROP TABLE AMCGDD.BI_DIMENSION_RANGO_ETARIO

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_AMBIENTES')
DROP TABLE AMCGDD.BI_DIMENSION_AMBIENTES

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_SUCURSAL')
DROP TABLE AMCGDD.BI_DIMENSION_SUCURSAL

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_DIMENSION_UBICACION')
DROP TABLE AMCGDD.BI_DIMENSION_UBICACION

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_BARRIO')
DROP TABLE AMCGDD.BI_BARRIO


IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_LOCALIDAD')
DROP TABLE AMCGDD.BI_LOCALIDAD

IF EXISTS (SELECT name FROM sys.tables WHERE name = 'BI_PROVINCIA')
DROP TABLE AMCGDD.BI_PROVINCIA

-----------LIMPIAMOS FUNCIONES

IF EXISTS(SELECT [name] FROM sys.objects WHERE [name] = 'cuatrimestreDe')
DROP FUNCTION AMCGDD.cuatrimestreDe



CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_MONEDA(
	MONEDA_NOMBRE NVARCHAR(100)
	PRIMARY KEY (MONEDA_NOMBRE)
)


CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_OPERACION(
	TIPO_OPERACION_ID NVARCHAR(20)
	PRIMARY KEY (TIPO_OPERACION_ID)
)


CREATE TABLE AMCGDD.BI_DIMENSION_TIPO_INMUEBLE(
	INMUEBLE_TIPO_ID NVARCHAR(100)
	PRIMARY KEY (INMUEBLE_TIPO_ID)
)


CREATE TABLE AMCGDD.BI_DIMENSION_TIEMPO(
	TIEMPO_ID INT IDENTITY,
	ANIO INT,
	MES INT,
	CUATRIMESTRE INT,
	PRIMARY KEY (TIEMPO_ID)
)


CREATE TABLE AMCGDD.BI_DIMENSION_RANGO_M2(
	RANGO_M2_ID NVARCHAR(20)
	PRIMARY KEY (RANGO_M2_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_RANGO_ETARIO(
	RANGO_ETARIO_ID NVARCHAR(20)
	PRIMARY KEY (RANGO_ETARIO_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_AMBIENTES(
	AMBIENTE_ID NVARCHAR(100)
	PRIMARY KEY (AMBIENTE_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_SUCURSAL(
	SUCURSAL_ID NUMERIC(19,0),
	SUCURSAL_NOMBRE NVARCHAR(100),
	PRIMARY KEY (SUCURSAL_ID)
)

CREATE TABLE AMCGDD.BI_DIMENSION_UBICACION(
	UBICACION_ID NUMERIC(19,0),
	BARRIO_ID NUMERIC(19,0),
	LOCALIDAD_ID NUMERIC(19,0),
	PROVINCIA_ID NUMERIC(19,0),
	PRIMARY KEY (UBICACION_ID)
)


CREATE TABLE AMCGDD.BI_LOCALIDAD(
	LOCALIDAD_ID NUMERIC(19,0),
	LOCALIDAD_NOMBRE NVARCHAR(100),
	LOCALIDAD_PROVINCIA NUMERIC(19,0),
	PRIMARY KEY (LOCALIDAD_ID)
)




CREATE TABLE AMCGDD.BI_PROVINCIA(
	PROVINCIA_ID NUMERIC(19,0),
	PROVINCIA_NOMBRE NVARCHAR(100),
	PRIMARY KEY (PROVINCIA_ID)
)


CREATE TABLE AMCGDD.BI_BARRIO(
	BARRIO_ID NUMERIC(19,0),
	BARRIO_NOMBRE NVARCHAR(100),
	BARRIO_LOCALIDAD_ID NUMERIC(19,0),
	PRIMARY KEY (BARRIO_ID)
)





-----AGREGAMOS CONSTRAINTS

ALTER TABLE AMCGDD.BI_BARRIO
ADD CONSTRAINT FK_BI_LOCALIDAD_ID
FOREIGN KEY (BARRIO_LOCALIDAD_ID) REFERENCES AMCGDD.BI_LOCALIDAD

ALTER TABLE AMCGDD.BI_LOCALIDAD
ADD CONSTRAINT FK_BI_PROVINCIA_ID
FOREIGN KEY (LOCALIDAD_PROVINCIA) REFERENCES AMCGDD.BI_PROVINCIA

----CREAMOS FUNCIONES


CREATE FUNCTION cuatrimestreDe(@fecha DATETIME)
RETURNS INT
AS
BEGIN
    DECLARE @cuatrimestre INT
    SET @cuatrimestre = 
        CASE 
            WHEN MONTH(@fecha) BETWEEN 1 AND 3 THEN 1
            WHEN MONTH(@fecha) BETWEEN 4 AND 6 THEN 2
            WHEN MONTH(@fecha) BETWEEN 7 AND 9 THEN 3
            WHEN MONTH(@fecha) BETWEEN 10 AND 12 THEN 4
            ELSE 0
			 -- En caso de fechas que no estén en un rango válido
        END
		IF @cuatrimestre = 0
			PRINT 'Fecha inválida'
    RETURN @cuatrimestre
END





SELECT * FROM AMCGDD.BI_PROVINCIA



INSERT INTO AMCGDD.BI_DIMENSION_TIPO_MONEDA
SELECT MONEDA_NOMBRE FROM AMCGDD.MONEDA

INSERT INTO AMCGDD.BI_PROVINCIA
SELECT * FROM AMCGDD.PROVINCIA

INSERT INTO AMCGDD.BI_LOCALIDAD
SELECT * FROM AMCGDD.LOCALIDAD

INSERT INTO AMCGDD.BI_BARRIO
SELECT * FROM AMCGDD.BARRIO


INSERT INTO AMCGDD.BI_DIMENSION_RANGO_ETARIO
VALUES('<25','25-35','35-50','>50')

INSERT INTO AMCGDD.BI_DIMENSION_RANGO_M2
VALUES('<35','35-55','55-75','75-100','100')


INSERT INTO AMCGDD.BI_DIMENSION_TIPO_INMUEBLE
SELECT NOMBRE FROM AMCGDD.TIPO


INSERT INTO AMCGDD.BI_DIMENSION_TIPO_OPERACION
SELECT * FROM AMCGDD.ANUNCIO_TIPOS

INSERT INTO AMCGDD.BI_DIMENSION_SUCURSAL 
SELECT SUCURSAL_ID, SUCURSAL_NOMBRE FROM AMCGDD.SUCURSAL

INSERT INTO AMCGDD.BI_DIMENSION_AMBIENTES
SELECT nombre FROM AMCGDD.INMUEBLE_AMBIENTE

INSERT INTO AMCGDD.BI_DIMENSION_TIEMPO
SELECT anuncio_fecha FROM AMCGDD.ANUNCIOS




SELECT * FROM AMCGDD.BI_DIMENSION_TIPO_MONEDA
SELECT * FROM AMCGDD.BI_BARRIO
SELECT * FROM AMCGDD.BI_LOCALIDAD
SELECT * FROM AMCGDD.BI_PROVINCIA
